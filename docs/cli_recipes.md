# Engine CLI Recipes

_Rev 1 – 2025-07-22_

This document lists the canonical command-line invocations used by GifLab’s external engine wrappers.  Each recipe consumes an input GIF and produces an output GIF that applies the requested transformation.  At runtime the wrappers substitute the placeholders below and may adjust numeric parameters dynamically.

Placeholders used below:

| Placeholder | Meaning |
|-------------|---------|
| `$IN_GIF`   | absolute/relative path to the input GIF |
| `$OUT_GIF`  | destination path for the transformed GIF |
| `$PALETTE_PNG` | temporary palette file generated by FFmpeg |
| `$PNG_DIR`  | temporary directory for intermediate PNG frames |

---
## 1  ImageMagick (`magick` / `convert`)

### 1.1  Color reduction
```bash
magick "$IN_GIF" +dither -colors 32 "$OUT_GIF"
# replace 32 with the desired palette size (e.g. 16, 64)
```

### 1.2  Frame reduction (drop every 2-nd frame)
```bash
magick "$IN_GIF" -coalesce -delete '1--2' -layers optimize "$OUT_GIF"
# wrap-side: delete pattern adjusted to achieve the requested ratio
```

### 1.3  Lossy compression
```bash
magick "$IN_GIF" -sampling-factor 4:2:0 -strip -quality 85 "$OUT_GIF"
# -quality ∈ [1-100]; wrapper selects value
```

---
## 2  FFmpeg (`ffmpeg`)

### 2.1  Color reduction via palette (two-pass)
```bash
ffmpeg -y -v error -i "$IN_GIF" -filter_complex "fps=15,palettegen" "$PALETTE_PNG"
ffmpeg -y -v error -i "$IN_GIF" -i "$PALETTE_PNG" -filter_complex "fps=15,paletteuse" "$OUT_GIF"
# fps value tweaked by wrapper; -y overwrites existing files silently
```

### 2.2  Frame reduction (single-pass)
```bash
ffmpeg -y -v error -i "$IN_GIF" -filter_complex "fps=7.5" "$OUT_GIF"
# target FPS selected to meet reduction target
```

### 2.3  Lossy compression (quantiser)
```bash
ffmpeg -y -v error -i "$IN_GIF" -lavfi "fps=15" -q:v 30 "$OUT_GIF"
# lower q:v ⇒ higher quality; wrapper maps quality ∈ [0-100] to q:v
```

---
## 3  gifski (`gifski`)

### 3.1  Lossy compression
```bash
# ❶ split GIF into PNG frames (ImageMagick)
magick "$IN_GIF" "$PNG_DIR/frame_%04d.png"

# ❷ encode with gifski
gifski --quality 60 -o "$OUT_GIF" "$PNG_DIR"/frame_*.png
# quality ∈ [0-100]; wrapper chooses value
```

⚠️  For small smoke-test fixtures (≲ 10 frames) the PNG split overhead is negligible.  For production use the wrapper will stream frames to minimise disk writes.

---
### 4  Notes & conventions

1. All commands are run via `subprocess.run(..., check=True)` from the Python wrappers.
2. The wrappers capture `stdout`, `stderr`, execution time, and final file size to populate the standard metadata dictionary (`render_ms`, `engine`, `command`, `kilobytes`).
3. Environment variables allow users/CI to override the executable paths:
   * `GIFLAB_IMAGEMAGICK_PATH`
   * `GIFLAB_FFMPEG_PATH`
   * `GIFLAB_GIFSKI_PATH`
   * `GIFLAB_GIFSICLE_PATH` (existing)
   * `GIFLAB_FFPROBE_PATH`
4. All recipes assume the executables are on `$PATH` if the env vars are unset.

*End of file* 